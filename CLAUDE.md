# CLAUDE.md

AI AML Agent - Browser automation for AML verification workflows using Playwright + Llama 4.

## Environment Setup

- **venv location**: `./venv` (activate with `source venv/bin/activate`)
- **Dependencies**: `pip install -r requirements.txt && playwright install chromium`
- **Secrets**: `.env` file with `TOGETHER_API_KEY` (use `direnv allow` for auto-load)
- **Python 3.14**: Set `PYTHON_JIT=1` for JIT performance boost

## Project Structure

- **playwright_client.py** - Core browser automation (async + sync APIs)
- **onboard_client.py** - Client onboarding generator
- **together_ai/** - Llama 4 Maverick client
- **test_amazon_real.py** - Working reference implementation
- **clients/** - Client-specific flows (generated by onboard_client.py)
- **test_screenshots/** - Auto-generated debug screenshots + metadata JSON

## Key Behavior Rules

**Critical:**
- **NEVER overwrite working code** - Only make additive changes
- **COMMIT working code immediately** after verification
- **NEVER run `onboard_client.py` on existing implementations** - It overwrites with templates
- **ALWAYS use Playwright (headless=True)** - Never use Puppeteer MCP tools
- **Check screenshots to debug** - Located in `test_screenshots/<client_id>/`

**Coding standards:**
- Never over-engineer - do exactly what was asked
- Use existing patterns from test_amazon_real.py
- Add comments instead of single-use helper functions
- Always use dynamic selector discovery with `browser.evaluate()`
- Include metadata with all screenshots (`save_metadata=True`)

## Client Debugging Workflow

When debugging a client:
1. Run test: `source venv/bin/activate && python clients/<client_id>/test_<client_id>.py`
2. Check screenshots in `test_screenshots/<client_id>/`
3. Fix errors (selectors, timeouts, URLs)
4. Verify with multiple runs
5. Commit when stable

## Web Search Policy

**ALWAYS web search for:**
- Playwright API syntax and best practices
- Python 3.14 features and syntax
- Any API or library you're uncertain about
- Security best practices

Search proactively - don't guess syntax or make assumptions.

## Authentication Caching

Use `storage_state` parameter to cache auth between runs:
- State saved to `clients/<client_id>/auth_state.json` (gitignored)
- Load with `storage_state=str(file)` if file exists
- Saves login time and reduces 2FA prompts

## Essential Patterns

- **Dynamic selectors**: Use `browser.evaluate()` with JavaScript to find selectors that exist
- **Screenshots with metadata**: Always use `save_metadata=True` for AML compliance
- **Keyboard shortcuts**: Use `browser.page.keyboard.press()` for single keys, sequences (with delays), and modifiers
- **Form values**: Set directly with `browser.evaluate()` instead of typing - much faster and more reliable
- **Reference implementations**: See `test_amazon_real.py` and `clients/[sandbar]/test_[sandbar].py` for working patterns

See [TESTING.md](TESTING.md) for detailed setup and debugging instructions.
